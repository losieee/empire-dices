<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Empire Dice Test Page</title>
</head>
<body>
<h1>Empire Dice Test Page</h1>

<input id="token" placeholder="JWT Token" style="width:350px;">
<button id="connect">소켓 연결</button>
<br><br>

<button id="createRoom">방 생성</button>
<input id="sessionId" placeholder="Session ID 입력" style="width:120px;">
<button id="joinRoom">방 입장</button>
<br><br>

<button id="rollDice" disabled>주사위 굴리기</button>
<br><br>

<h3>로그</h3>
<pre id="log" style="width:100%;height:300px;background:#eee;padding:10px;overflow-y:scroll;"></pre>

<script>
let socket = null
let currentRoom = null
let myUserId = null

function log(msg){
    const box=document.getElementById("log")
    box.innerHTML+=msg+"\n"
    box.scrollTop=box.scrollHeight
}

document.getElementById("connect").onclick=()=>{
    if(socket) return log("이미 연결됨")
    const token=document.getElementById("token").value
    try{
        myUserId=JSON.parse(atob(token.split(".")[1])).user_id
    }catch(e){
        return log("JWT Token 입력 필요")
    }

    socket=new WebSocket("ws://localhost:3000")

    socket.onopen=()=>{
        log("연결됨")
        socket.send(JSON.stringify({type:"auth",token}))
    }

    socket.onmessage=(event)=>{
        const msg=JSON.parse(event.data)
        const type=msg.type

        if(type==="auth_ok") log("인증 성공 user="+msg.userId)
        if(type==="auth_fail") log("인증 실패")

        if(type==="roomCreated"){
            currentRoom=msg.sessionId
            document.getElementById("sessionId").value=msg.sessionId
            log("방 생성 "+msg.sessionId)
        }

        if(type==="joinedRoom"){
            currentRoom=msg.sessionId
            log("방 입장 "+msg.sessionId)
            document.getElementById("rollDice").disabled=false
        }

        if(type==="players") log("players "+JSON.stringify(msg.players))
        if(type==="dice") log("dice "+msg.dice)
    }
}

document.getElementById("createRoom").onclick=()=>{
    socket.send(JSON.stringify({type:"createRoom"}))
    log("createRoom 요청")
}

document.getElementById("joinRoom").onclick=()=>{
    const id=document.getElementById("sessionId").value
    socket.send(JSON.stringify({type:"joinRoom",sessionId:id}))
    log("joinRoom 요청")
}

document.getElementById("rollDice").onclick=()=>{
    socket.send(JSON.stringify({type:"rollDice"}))
    log("rollDice 요청")
}
</script>
</body>
</html>
